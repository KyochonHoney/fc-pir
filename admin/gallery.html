<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°¤ëŸ¬ë¦¬ ê´€ë¦¬ - FC PIR</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        /* ... (ê¸°ì¡´ ìŠ¤íƒ€ì¼ì€ ë³€ê²½ ì—†ìŒ) ... */
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">âš½ FC PIR</a>
            <div class="navbar-menu">
                <a href="/">í™ˆ</a>
                <a href="/team-generator.html">íŒ€ í¸ì„±</a>
                <a href="/payment-status.html">íšŒë¹„ í˜„í™©</a>
                <a href="/gallery.html">ê°¤ëŸ¬ë¦¬</a>
                <a href="/admin/">ê´€ë¦¬ì</a>
                <a href="#" id="logoutBtn" style="color: #dc3545;">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px;">
        <div class="page-title">
            <h2>ğŸ“¸ ê°¤ëŸ¬ë¦¬ ê´€ë¦¬</h2>
            <p>íŒ€ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ê³  ê´€ë¦¬í•©ë‹ˆë‹¤</p>
        </div>

        <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
        <div class="upload-section">
            <h3 style="margin-bottom: 20px;">ğŸ“¤ ì‚¬ì§„ ì—…ë¡œë“œ</h3>
            <form id="uploadForm">
                <!-- ... (í¼ ë‚´ìš©ì€ ë³€ê²½ ì—†ìŒ) ... -->
            </form>
        </div>

        <!-- ê°¤ëŸ¬ë¦¬ ëª©ë¡ -->
        <div style="margin-top: 40px;">
            <h3>ğŸ“‹ ì—…ë¡œë“œëœ ì‚¬ì§„ (<span id="imageCount">0</span>ê°œ)</h3>
            <div id="galleryContainer">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>

    <!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
    <div id="imageModal" class="image-modal">
        <span id="modalCloseBtn" class="modal-close">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
    </div>

    <footer style="background: #2c3e50; color: white; text-align: center; padding: 20px; margin-top: 50px;">
        <p>&copy; 2025 FC PIR. All rights reserved.</p>
    </footer>

    <script type="module">
        import storage from '/js/storage-firebase.js';

        // HTML ì´ìŠ¤ì¼€ì´í”„ í—¬í¼ í•¨ìˆ˜
        const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        // í˜ì´ì§€ ì´ˆê¸°í™” í•¨ìˆ˜
        async function initializePage() {
            // ê´€ë¦¬ì ì¸ì¦ í™•ì¸
            const isLoggedIn = await storage.isAdminLoggedIn();
            if (!isLoggedIn) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/admin/login.html';
                return; // ì¸ì¦ ì‹¤íŒ¨ ì‹œ ë‚˜ë¨¸ì§€ ì½”ë“œ ì‹¤í–‰ ì¤‘ë‹¨
            }

            // DOM ìš”ì†Œ ìºì‹±
            const uploadForm = document.getElementById('uploadForm');
            const imageFile = document.getElementById('imageFile');
            const fileLabel = document.getElementById('fileLabel');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const galleryContainer = document.getElementById('galleryContainer');
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            let selectedImageData = null;

            // ì´ë¯¸ì§€ ì••ì¶• í•¨ìˆ˜
            const compressImage = (file, maxWidth = 1920, quality = 0.85) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let { width, height } = img;
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob(
                                (blob) => {
                                    const compressedReader = new FileReader();
                                    compressedReader.onload = (e) => resolve(e.target.result);
                                    compressedReader.onerror = reject;
                                    compressedReader.readAsDataURL(blob);
                                },
                                'image/jpeg',
                                quality
                            );
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            // ê°¤ëŸ¬ë¦¬ ë¡œë“œ í•¨ìˆ˜
            const loadGallery = async () => {
                const images = await storage.getGalleryImages();
                document.getElementById('imageCount').textContent = images.length;

                if (images.length === 0) {
                    galleryContainer.innerHTML = `
                        <div class="empty-gallery">
                            <div class="empty-gallery-icon">ğŸ“·</div>
                            <h3>ì•„ì§ ì—…ë¡œë“œëœ ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                            <p>ìœ„ì˜ ì—…ë¡œë“œ í¼ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ì§„ì„ ì¶”ê°€í•˜ì„¸ìš”</p>
                        </div>
                    `;
                    return;
                }

                galleryContainer.innerHTML = `<div class="gallery-grid">${images.map(image => {
                    const date = new Date(image.created_at).toLocaleDateString('ko-KR');
                    return `
                        <div class="gallery-item">
                            <img src="${image.image_data}" alt="${escapeHtml(image.title)}" class="gallery-item-image" data-image-src="${image.image_data}">
                            <div class="gallery-item-content">
                                <div class="gallery-item-title">${escapeHtml(image.title)}</div>
                                ${image.description ? `<div class="gallery-item-description">${escapeHtml(image.description)}</div>` : ''}
                                <div class="gallery-item-date">${date}</div>
                                <div class="gallery-item-actions">
                                    <button class="btn btn-danger btn-delete" data-id="${image.id}" style="flex: 1;">ì‚­ì œ</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}</div>`;
            };

            // ì´ë¯¸ì§€ ëª¨ë‹¬ í•¨ìˆ˜
            const openImageModal = (imageSrc) => {
                modalImage.src = imageSrc;
                imageModal.classList.add('active');
            };
            const closeImageModal = () => imageModal.classList.remove('active');

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    await storage.adminLogout();
                    window.location.href = '/admin/login.html';
                }
            });

            imageFile.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const isValidType = file.type.startsWith('image/') || file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');
                if (!isValidType) {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    e.target.value = '';
                    return;
                }

                fileLabel.innerHTML = `... ì²˜ë¦¬ ì¤‘ ...`;
                try {
                    selectedImageData = await compressImage(file);
                    previewImage.src = selectedImageData;
                    previewContainer.classList.add('active');
                    fileLabel.classList.add('has-file');
                    fileLabel.innerHTML = `âœ… ì´ë¯¸ì§€ ì„ íƒë¨: ${escapeHtml(file.name)}`;
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    e.target.value = '';
                    fileLabel.innerHTML = `ğŸ“ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ`;
                }
            });

            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedImageData) {
                    alert('ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                const title = document.getElementById('title').value.trim();
                if (!title) {
                    alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                const description = document.getElementById('description').value.trim();

                try {
                    await storage.addGalleryImage(title, description, selectedImageData);
                    alert('ì‚¬ì§„ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    uploadForm.reset();
                    previewContainer.classList.remove('active');
                    fileLabel.classList.remove('has-file');
                    fileLabel.innerHTML = `ğŸ“ í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ ì„ íƒ`;
                    selectedImageData = null;
                    await loadGallery();
                } catch (error) {
                    console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });

            galleryContainer.addEventListener('click', async (e) => {
                // ì‚­ì œ ë²„íŠ¼ í´ë¦­
                if (e.target.matches('.btn-delete')) {
                    const id = e.target.dataset.id;
                    if (confirm('ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        await storage.deleteGalleryImage(id);
                        alert('ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        await loadGallery();
                    }
                }
                // ì´ë¯¸ì§€ í´ë¦­ (ëª¨ë‹¬ ì—´ê¸°)
                if (e.target.matches('.gallery-item-image')) {
                    openImageModal(e.target.dataset.imageSrc);
                }
            });

            // ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
            document.getElementById('modalCloseBtn').addEventListener('click', closeImageModal);
            imageModal.addEventListener('click', (e) => e.target === imageModal && closeImageModal());
            document.addEventListener('keydown', (e) => e.key === 'Escape' && closeImageModal());

            // ì´ˆê¸° ê°¤ëŸ¬ë¦¬ ë¡œë“œ
            await loadGallery();
        }

        // DOMContentLoaded ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
