<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>갤러리 관리 - FC PIR</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        /* ... (기존 스타일은 변경 없음) ... */
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">⚽ FC PIR</a>
            <div class="navbar-menu">
                <a href="/">홈</a>
                <a href="/team-generator.html">팀 편성</a>
                <a href="/payment-status.html">회비 현황</a>
                <a href="/gallery.html">갤러리</a>
                <a href="/admin/">관리자</a>
                <a href="#" id="logoutBtn" style="color: #dc3545;">로그아웃</a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px;">
        <div class="page-title">
            <h2>📸 갤러리 관리</h2>
            <p>팀 사진을 업로드하고 관리합니다</p>
        </div>

        <!-- 업로드 섹션 -->
        <div class="upload-section">
            <h3 style="margin-bottom: 20px;">📤 사진 업로드</h3>
            <form id="uploadForm">
                <!-- ... (폼 내용은 변경 없음) ... -->
            </form>
        </div>

        <!-- 갤러리 목록 -->
        <div style="margin-top: 40px;">
            <h3>📋 업로드된 사진 (<span id="imageCount">0</span>개)</h3>
            <div id="galleryContainer">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </div>
    </div>

    <!-- 이미지 모달 -->
    <div id="imageModal" class="image-modal">
        <span id="modalCloseBtn" class="modal-close">&times;</span>
        <img id="modalImage" class="image-modal-content" src="" alt="">
    </div>

    <footer style="background: #2c3e50; color: white; text-align: center; padding: 20px; margin-top: 50px;">
        <p>&copy; 2025 FC PIR. All rights reserved.</p>
    </footer>

    <script type="module">
        import storage from '/js/storage-firebase.js';

        // HTML 이스케이프 헬퍼 함수
        const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        // 페이지 초기화 함수
        async function initializePage() {
            // 관리자 인증 확인
            const isLoggedIn = await storage.isAdminLoggedIn();
            if (!isLoggedIn) {
                alert('로그인이 필요합니다.');
                window.location.href = '/admin/login.html';
                return; // 인증 실패 시 나머지 코드 실행 중단
            }

            // DOM 요소 캐싱
            const uploadForm = document.getElementById('uploadForm');
            const imageFile = document.getElementById('imageFile');
            const fileLabel = document.getElementById('fileLabel');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const galleryContainer = document.getElementById('galleryContainer');
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');

            let selectedImageData = null;

            // 이미지 압축 함수
            const compressImage = (file, maxWidth = 1920, quality = 0.85) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let { width, height } = img;
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            canvas.toBlob(
                                (blob) => {
                                    const compressedReader = new FileReader();
                                    compressedReader.onload = (e) => resolve(e.target.result);
                                    compressedReader.onerror = reject;
                                    compressedReader.readAsDataURL(blob);
                                },
                                'image/jpeg',
                                quality
                            );
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            };

            // 갤러리 로드 함수
            const loadGallery = async () => {
                const images = await storage.getGalleryImages();
                document.getElementById('imageCount').textContent = images.length;

                if (images.length === 0) {
                    galleryContainer.innerHTML = `
                        <div class="empty-gallery">
                            <div class="empty-gallery-icon">📷</div>
                            <h3>아직 업로드된 사진이 없습니다</h3>
                            <p>위의 업로드 폼을 사용하여 사진을 추가하세요</p>
                        </div>
                    `;
                    return;
                }

                galleryContainer.innerHTML = `<div class="gallery-grid">${images.map(image => {
                    const date = new Date(image.created_at).toLocaleDateString('ko-KR');
                    return `
                        <div class="gallery-item">
                            <img src="${image.image_data}" alt="${escapeHtml(image.title)}" class="gallery-item-image" data-image-src="${image.image_data}">
                            <div class="gallery-item-content">
                                <div class="gallery-item-title">${escapeHtml(image.title)}</div>
                                ${image.description ? `<div class="gallery-item-description">${escapeHtml(image.description)}</div>` : ''}
                                <div class="gallery-item-date">${date}</div>
                                <div class="gallery-item-actions">
                                    <button class="btn btn-danger btn-delete" data-id="${image.id}" style="flex: 1;">삭제</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}</div>`;
            };

            // 이미지 모달 함수
            const openImageModal = (imageSrc) => {
                modalImage.src = imageSrc;
                imageModal.classList.add('active');
            };
            const closeImageModal = () => imageModal.classList.remove('active');

            // 이벤트 리스너 등록
            document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm('로그아웃하시겠습니까?')) {
                    await storage.adminLogout();
                    window.location.href = '/admin/login.html';
                }
            });

            imageFile.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const isValidType = file.type.startsWith('image/') || file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');
                if (!isValidType) {
                    alert('이미지 파일만 업로드 가능합니다.');
                    e.target.value = '';
                    return;
                }

                fileLabel.innerHTML = `... 처리 중 ...`;
                try {
                    selectedImageData = await compressImage(file);
                    previewImage.src = selectedImageData;
                    previewContainer.classList.add('active');
                    fileLabel.classList.add('has-file');
                    fileLabel.innerHTML = `✅ 이미지 선택됨: ${escapeHtml(file.name)}`;
                } catch (error) {
                    console.error('이미지 처리 오류:', error);
                    alert('이미지 처리 중 오류가 발생했습니다.');
                    e.target.value = '';
                    fileLabel.innerHTML = `📁 클릭하여 이미지 선택`;
                }
            });

            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedImageData) {
                    alert('이미지를 선택해주세요.');
                    return;
                }
                const title = document.getElementById('title').value.trim();
                if (!title) {
                    alert('제목을 입력해주세요.');
                    return;
                }
                const description = document.getElementById('description').value.trim();

                try {
                    await storage.addGalleryImage(title, description, selectedImageData);
                    alert('사진이 업로드되었습니다.');
                    uploadForm.reset();
                    previewContainer.classList.remove('active');
                    fileLabel.classList.remove('has-file');
                    fileLabel.innerHTML = `📁 클릭하여 이미지 선택`;
                    selectedImageData = null;
                    await loadGallery();
                } catch (error) {
                    console.error('업로드 오류:', error);
                    alert('업로드 중 오류가 발생했습니다.');
                }
            });

            galleryContainer.addEventListener('click', async (e) => {
                // 삭제 버튼 클릭
                if (e.target.matches('.btn-delete')) {
                    const id = e.target.dataset.id;
                    if (confirm('이 사진을 삭제하시겠습니까?')) {
                        await storage.deleteGalleryImage(id);
                        alert('사진이 삭제되었습니다.');
                        await loadGallery();
                    }
                }
                // 이미지 클릭 (모달 열기)
                if (e.target.matches('.gallery-item-image')) {
                    openImageModal(e.target.dataset.imageSrc);
                }
            });

            // 모달 닫기 이벤트
            document.getElementById('modalCloseBtn').addEventListener('click', closeImageModal);
            imageModal.addEventListener('click', (e) => e.target === imageModal && closeImageModal());
            document.addEventListener('keydown', (e) => e.key === 'Escape' && closeImageModal());

            // 초기 갤러리 로드
            await loadGallery();
        }

        // DOMContentLoaded 이벤트가 발생하면 페이지 초기화 시작
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
