<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회비 관리 - FC PIR</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        /* CSS는 변경 사항 없음 */
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">⚽ FC PIR</a>
            <div class="navbar-menu">
                <a href="/">홈</a>
                <a href="/team-generator.html">팀 편성</a>
                <a href="/payment-status.html">회비 현황</a>
                <a href="/admin/">관리자</a>
                <a href="#" id="logoutBtn" style="color: #dc3545;">로그아웃</a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px;">
        <div class="page-title">
            <h2>💰 회비 관리</h2>
            <p>회원들의 월별 회비를 관리합니다 (셀 클릭으로 납부 처리/금액 입력)</p>
        </div>

        <!-- 통계, 범례, 연도 선택기 등 HTML 구조는 변경 없음 -->

        <div class="card">
            <div class="payment-matrix" id="paymentMatrix">
                <!-- JavaScript로 동적 생성 -->
            </div>
        </div>
    </div>

    <!-- 회비 등록/수정 모달 -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <!-- ... 모달 내용 ... -->
            <div class="modal-actions">
                <button id="modalCancelBtn" class="btn btn-secondary">취소</button>
                <button id="modalSaveBtn" class="btn btn-primary">저장</button>
            </div>
        </div>
    </div>

    <!-- 회비 관리 옵션 모달 -->
    <div id="paymentOptionsModal" class="modal">
        <div class="modal-content">
            <!-- ... 모달 내용 ... -->
            <div class="modal-actions" style="flex-direction: column; gap: 10px;">
                <button id="optionToggleBtn" class="btn btn-primary" style="width: 100%;"></button>
                <button id="optionEditBtn" class="btn" style="background: #ffc107; color: #000; width: 100%;">수정</button>
                <button id="optionDeleteBtn" class="btn btn-danger" style="width: 100%;">삭제</button>
                <button id="optionCancelBtn" class="btn btn-secondary" style="width: 100%;">취소</button>
            </div>
        </div>
    </div>

    <footer style="background: #2c3e50; color: white; text-align: center; padding: 20px; margin-top: 50px;">
        <p>&copy; 2025 FC PIR. All rights reserved.</p>
    </footer>

    <script type="module">
        import storage from '/js/storage-firebase.js';

        // 전역 상태 변수
        let currentYear = new Date().getFullYear();
        let members = [];
        let matrix = [];
        let currentCellData = null; // { memberId, month, paymentId, isPaid }

        // DOM 요소 캐싱
        const DOMElements = {
            currentYear: document.getElementById('currentYear'),
            paymentMatrix: document.getElementById('paymentMatrix'),
            paymentModal: document.getElementById('paymentModal'),
            optionsModal: document.getElementById('paymentOptionsModal'),
            // 추가적인 DOM 요소들...
        };

        // 헬퍼 함수
        const formatCurrency = (amount) => amount === 0 ? '0원' : `${amount.toLocaleString()}원`;
        const formatAmount = (amount) => amount >= 10000 ? `${amount / 10000}만` : `${amount.toLocaleString()}원`;
        const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        // 데이터 로드 및 뷰 업데이트
        async function updateView(year) {
            DOMElements.currentYear.textContent = year;
            [members, matrix] = await Promise.all([
                storage.getMembers(true),
                storage.getPaymentMatrix(year)
            ]);
            renderStatistics();
            renderPaymentMatrix();
        }

        // 통계 렌더링
        function renderStatistics() {
            let totalPaid = 0, totalUnpaid = 0, totalAmount = 0;
            matrix.forEach(row => {
                Object.values(row.months).forEach(p => {
                    if (p) {
                        p.paid ? (totalPaid++, totalAmount += p.amount) : totalUnpaid++;
                    }
                });
            });
            const totalPayments = totalPaid + totalUnpaid;
            const paymentRate = totalPayments > 0 ? Math.round((totalPaid / totalPayments) * 100) : 0;
            document.getElementById('paymentRate').textContent = `${paymentRate}%`;
            document.getElementById('paidCount').textContent = `${totalPaid}건`;
            document.getElementById('unpaidCount').textContent = `${totalUnpaid}건`;
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
        }

        // 매트릭스 렌더링
        function renderPaymentMatrix() {
            // ... (payment-status.html과 유사한 로직, 단 셀에 data 속성 추가)
            const tableHtml = `...`; // 복잡한 HTML 생성 로직
            DOMElements.paymentMatrix.innerHTML = tableHtml;
        }

        // 모달 핸들링
        const closeModal = (modal) => modal.classList.remove('active');
        const openModal = (modal) => modal.classList.add('active');

        // 이벤트 핸들러
        async function handleCellClick(memberId, month) {
            const payment = matrix.find(r => r.member_id === memberId)?.months[month];
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            currentCellData = { memberId, month, paymentId: payment?.id, isPaid: payment?.paid, memberName: member.name, payment };

            if (payment) {
                // 옵션 모달 열기
                // ...
                openModal(DOMElements.optionsModal);
            } else {
                // 등록 모달 열기
                // ...
                openModal(DOMElements.paymentModal);
            }
        }

        async function savePayment() {
            // ...
            await storage.addPayment(...);
            // or
            await storage.updatePayment(...);
            closeModal(DOMElements.paymentModal);
            await updateView(currentYear);
        }

        async function deletePayment() {
            // ...
            await storage.deletePayment(currentCellData.paymentId);
            closeModal(DOMElements.optionsModal);
            await updateView(currentYear);
        }

        async function togglePaymentStatus() {
            // ...
            await storage.updatePayment(currentCellData.paymentId, !currentCellData.isPaid);
            closeModal(DOMElements.optionsModal);
            await updateView(currentYear);
        }

        // 페이지 초기화
        async function initialize() {
            if (!await storage.isAdminLoggedIn()) {
                alert('로그인이 필요합니다.');
                return window.location.href = '/admin/login.html';
            }

            await updateView(currentYear);

            // 이벤트 리스너 등록
            document.getElementById('prevYearBtn').addEventListener('click', () => updateView(--currentYear));
            document.getElementById('nextYearBtn').addEventListener('click', () => updateView(++currentYear));
            document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm('로그아웃하시겠습니까?')) {
                    await storage.adminLogout();
                    window.location.href = '/admin/login.html';
                }
            });

            DOMElements.paymentMatrix.addEventListener('click', (e) => {
                const cell = e.target.closest('.payment-cell');
                if (cell) {
                    const memberId = parseInt(cell.dataset.memberId);
                    const month = parseInt(cell.dataset.month);
                    handleCellClick(memberId, month);
                }
            });
            
            // 모달 버튼 이벤트 리스너들...
            document.getElementById('modalSaveBtn').addEventListener('click', savePayment);
            document.getElementById('optionDeleteBtn').addEventListener('click', deletePayment);
            document.getElementById('optionToggleBtn').addEventListener('click', togglePaymentStatus);
            // ... 기타 모달 버튼
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
