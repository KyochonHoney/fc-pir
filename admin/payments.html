<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒë¹„ ê´€ë¦¬ - FC PIR</title>
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        /* CSSëŠ” ë³€ê²½ ì‚¬í•­ ì—†ìŒ */
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="navbar-brand">âš½ FC PIR</a>
            <div class="navbar-menu">
                <a href="/">í™ˆ</a>
                <a href="/team-generator.html">íŒ€ í¸ì„±</a>
                <a href="/payment-status.html">íšŒë¹„ í˜„í™©</a>
                <a href="/admin/">ê´€ë¦¬ì</a>
                <a href="#" id="logoutBtn" style="color: #dc3545;">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 30px;">
        <div class="page-title">
            <h2>ğŸ’° íšŒë¹„ ê´€ë¦¬</h2>
            <p>íšŒì›ë“¤ì˜ ì›”ë³„ íšŒë¹„ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤ (ì…€ í´ë¦­ìœ¼ë¡œ ë‚©ë¶€ ì²˜ë¦¬/ê¸ˆì•¡ ì…ë ¥)</p>
        </div>

        <!-- í†µê³„, ë²”ë¡€, ì—°ë„ ì„ íƒê¸° ë“± HTML êµ¬ì¡°ëŠ” ë³€ê²½ ì—†ìŒ -->

        <div class="card">
            <div class="payment-matrix" id="paymentMatrix">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>
    </div>

    <!-- íšŒë¹„ ë“±ë¡/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <!-- ... ëª¨ë‹¬ ë‚´ìš© ... -->
            <div class="modal-actions">
                <button id="modalCancelBtn" class="btn btn-secondary">ì·¨ì†Œ</button>
                <button id="modalSaveBtn" class="btn btn-primary">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- íšŒë¹„ ê´€ë¦¬ ì˜µì…˜ ëª¨ë‹¬ -->
    <div id="paymentOptionsModal" class="modal">
        <div class="modal-content">
            <!-- ... ëª¨ë‹¬ ë‚´ìš© ... -->
            <div class="modal-actions" style="flex-direction: column; gap: 10px;">
                <button id="optionToggleBtn" class="btn btn-primary" style="width: 100%;"></button>
                <button id="optionEditBtn" class="btn" style="background: #ffc107; color: #000; width: 100%;">ìˆ˜ì •</button>
                <button id="optionDeleteBtn" class="btn btn-danger" style="width: 100%;">ì‚­ì œ</button>
                <button id="optionCancelBtn" class="btn btn-secondary" style="width: 100%;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <footer style="background: #2c3e50; color: white; text-align: center; padding: 20px; margin-top: 50px;">
        <p>&copy; 2025 FC PIR. All rights reserved.</p>
    </footer>

    <script type="module">
        import storage from '/js/storage-firebase.js';

        // ì „ì—­ ìƒíƒœ ë³€ìˆ˜
        let currentYear = new Date().getFullYear();
        let members = [];
        let matrix = [];
        let currentCellData = null; // { memberId, month, paymentId, isPaid }

        // DOM ìš”ì†Œ ìºì‹±
        const DOMElements = {
            currentYear: document.getElementById('currentYear'),
            paymentMatrix: document.getElementById('paymentMatrix'),
            paymentModal: document.getElementById('paymentModal'),
            optionsModal: document.getElementById('paymentOptionsModal'),
            // ì¶”ê°€ì ì¸ DOM ìš”ì†Œë“¤...
        };

        // í—¬í¼ í•¨ìˆ˜
        const formatCurrency = (amount) => amount === 0 ? '0ì›' : `${amount.toLocaleString()}ì›`;
        const formatAmount = (amount) => amount >= 10000 ? `${amount / 10000}ë§Œ` : `${amount.toLocaleString()}ì›`;
        const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        // ë°ì´í„° ë¡œë“œ ë° ë·° ì—…ë°ì´íŠ¸
        async function updateView(year) {
            DOMElements.currentYear.textContent = year;
            [members, matrix] = await Promise.all([
                storage.getMembers(true),
                storage.getPaymentMatrix(year)
            ]);
            renderStatistics();
            renderPaymentMatrix();
        }

        // í†µê³„ ë Œë”ë§
        function renderStatistics() {
            let totalPaid = 0, totalUnpaid = 0, totalAmount = 0;
            matrix.forEach(row => {
                Object.values(row.months).forEach(p => {
                    if (p) {
                        p.paid ? (totalPaid++, totalAmount += p.amount) : totalUnpaid++;
                    }
                });
            });
            const totalPayments = totalPaid + totalUnpaid;
            const paymentRate = totalPayments > 0 ? Math.round((totalPaid / totalPayments) * 100) : 0;
            document.getElementById('paymentRate').textContent = `${paymentRate}%`;
            document.getElementById('paidCount').textContent = `${totalPaid}ê±´`;
            document.getElementById('unpaidCount').textContent = `${totalUnpaid}ê±´`;
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
        }

        // ë§¤íŠ¸ë¦­ìŠ¤ ë Œë”ë§
        function renderPaymentMatrix() {
            // ... (payment-status.htmlê³¼ ìœ ì‚¬í•œ ë¡œì§, ë‹¨ ì…€ì— data ì†ì„± ì¶”ê°€)
            const tableHtml = `...`; // ë³µì¡í•œ HTML ìƒì„± ë¡œì§
            DOMElements.paymentMatrix.innerHTML = tableHtml;
        }

        // ëª¨ë‹¬ í•¸ë“¤ë§
        const closeModal = (modal) => modal.classList.remove('active');
        const openModal = (modal) => modal.classList.add('active');

        // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        async function handleCellClick(memberId, month) {
            const payment = matrix.find(r => r.member_id === memberId)?.months[month];
            const member = members.find(m => m.id === memberId);
            if (!member) return;

            currentCellData = { memberId, month, paymentId: payment?.id, isPaid: payment?.paid, memberName: member.name, payment };

            if (payment) {
                // ì˜µì…˜ ëª¨ë‹¬ ì—´ê¸°
                // ...
                openModal(DOMElements.optionsModal);
            } else {
                // ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
                // ...
                openModal(DOMElements.paymentModal);
            }
        }

        async function savePayment() {
            // ...
            await storage.addPayment(...);
            // or
            await storage.updatePayment(...);
            closeModal(DOMElements.paymentModal);
            await updateView(currentYear);
        }

        async function deletePayment() {
            // ...
            await storage.deletePayment(currentCellData.paymentId);
            closeModal(DOMElements.optionsModal);
            await updateView(currentYear);
        }

        async function togglePaymentStatus() {
            // ...
            await storage.updatePayment(currentCellData.paymentId, !currentCellData.isPaid);
            closeModal(DOMElements.optionsModal);
            await updateView(currentYear);
        }

        // í˜ì´ì§€ ì´ˆê¸°í™”
        async function initialize() {
            if (!await storage.isAdminLoggedIn()) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return window.location.href = '/admin/login.html';
            }

            await updateView(currentYear);

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('prevYearBtn').addEventListener('click', () => updateView(--currentYear));
            document.getElementById('nextYearBtn').addEventListener('click', () => updateView(++currentYear));
            document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    await storage.adminLogout();
                    window.location.href = '/admin/login.html';
                }
            });

            DOMElements.paymentMatrix.addEventListener('click', (e) => {
                const cell = e.target.closest('.payment-cell');
                if (cell) {
                    const memberId = parseInt(cell.dataset.memberId);
                    const month = parseInt(cell.dataset.month);
                    handleCellClick(memberId, month);
                }
            });
            
            // ëª¨ë‹¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤...
            document.getElementById('modalSaveBtn').addEventListener('click', savePayment);
            document.getElementById('optionDeleteBtn').addEventListener('click', deletePayment);
            document.getElementById('optionToggleBtn').addEventListener('click', togglePaymentStatus);
            // ... ê¸°íƒ€ ëª¨ë‹¬ ë²„íŠ¼
        }

        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
